"use strict";var LightMapDemoScene=function(e){this.gl=e};LightMapDemoScene.prototype.Load=function(e){console.log("Loading demo scene");var o=this;console.log(o),async.parallel({Models:function(e){async.map({RoomModel:"Room.json"},LoadJSONResource,e)},ShaderCode:function(e){async.map({NoShadow_VSText:"shaders/NoShadow.vs.glsl",NoShadow_FSText:"shaders/NoShadow.fs.glsl",Shadow_VSText:"shaders/Shadow.vs.glsl",Shadow_FSText:"shaders/Shadow.fs.glsl",ShadowMapGen_VSText:"shaders/ShadowMapGen.vs.glsl",ShadowMapGen_FSText:"shaders/ShadowMapGen.fs.glsl"},LoadTextResource,e)}},(function(a,r){if(a)e(a);else{for(var t=0;t<r.Models.RoomModel.meshes.length;t++){var s=r.Models.RoomModel.meshes[t];switch(s.name){case"MonkeyMesh":o.MonkeyMesh=new Model(o.gl,s.vertices,[].concat.apply([],s.faces),s.normals,vec4.fromValues(.8,.8,1,1)),mat4.rotate(o.MonkeyMesh.world,o.MonkeyMesh.world,glMatrix.toRadian(94.87),vec3.fromValues(0,0,-1)),mat4.translate(o.MonkeyMesh.world,o.MonkeyMesh.world,vec4.fromValues(2.07919,-.98559,1.7574));break;case"TableMesh":o.TableMesh=new Model(o.gl,s.vertices,[].concat.apply([],s.faces),s.normals,vec4.fromValues(1,0,1,1)),mat4.translate(o.TableMesh.world,o.TableMesh.world,vec3.fromValues(1.57116,-.79374,.49672));break;case"SofaMesh":o.SofaMesh=new Model(o.gl,s.vertices,[].concat.apply([],s.faces),s.normals,vec4.fromValues(0,1,1,1)),mat4.translate(o.SofaMesh.world,o.SofaMesh.world,vec3.fromValues(-3.28768,0,.78448));break;case"LightBulbMesh":o.lightPosition=vec3.fromValues(0,0,2.58971),o.LightMesh=new Model(o.gl,s.vertices,[].concat.apply([],s.faces),s.normals,vec4.fromValues(4,4,4,1)),mat4.translate(o.LightMesh.world,o.LightMesh.world,o.lightPosition);break;case"WallsMesh":o.WallsMesh=new Model(o.gl,s.vertices,[].concat.apply([],s.faces),s.normals,vec4.fromValues(.3,.3,.3,1))}}if(o.MonkeyMesh)if(o.TableMesh)if(o.SofaMesh)if(o.LightMesh)if(o.WallsMesh)if(o.Meshes=[o.MonkeyMesh,o.TableMesh,o.SofaMesh,o.LightMesh,o.WallsMesh],o.NoShadowProgram=CreateShaderProgram(o.gl,r.ShaderCode.NoShadow_VSText,r.ShaderCode.NoShadow_FSText),o.NoShadowProgram.error)e("NoShadowProgram "+o.NoShadowProgram.error);else if(o.ShadowProgram=CreateShaderProgram(o.gl,r.ShaderCode.Shadow_VSText,r.ShaderCode.Shadow_FSText),o.ShadowProgram.error)e("ShadowProgram "+o.ShadowProgram.error);else if(o.ShadowMapGenProgram=CreateShaderProgram(o.gl,r.ShaderCode.ShadowMapGen_VSText,r.ShaderCode.ShadowMapGen_FSText),o.ShadowMapGenProgram.error)e("ShadowMapGenProgram "+o.ShadowMapGenProgram.error);else{if(o.NoShadowProgram.uniforms={mProj:o.gl.getUniformLocation(o.NoShadowProgram,"mProj"),mView:o.gl.getUniformLocation(o.NoShadowProgram,"mView"),mWorld:o.gl.getUniformLocation(o.NoShadowProgram,"mWorld"),pointLightPosition:o.gl.getUniformLocation(o.NoShadowProgram,"pointLightPosition"),meshColor:o.gl.getUniformLocation(o.NoShadowProgram,"meshColor")},o.NoShadowProgram.attribs={vPos:o.gl.getAttribLocation(o.NoShadowProgram,"vPos"),vNorm:o.gl.getAttribLocation(o.NoShadowProgram,"vNorm")},o.ShadowProgram.uniforms={mProj:o.gl.getUniformLocation(o.ShadowProgram,"mProj"),mView:o.gl.getUniformLocation(o.ShadowProgram,"mView"),mWorld:o.gl.getUniformLocation(o.ShadowProgram,"mWorld"),pointLightPosition:o.gl.getUniformLocation(o.ShadowProgram,"pointLightPosition"),meshColor:o.gl.getUniformLocation(o.ShadowProgram,"meshColor"),lightShadowMap:o.gl.getUniformLocation(o.ShadowProgram,"lightShadowMap"),shadowClipNearFar:o.gl.getUniformLocation(o.ShadowProgram,"shadowClipNearFar"),bias:o.gl.getUniformLocation(o.ShadowProgram,"bias")},o.ShadowProgram.attribs={vPos:o.gl.getAttribLocation(o.ShadowProgram,"vPos"),vNorm:o.gl.getAttribLocation(o.ShadowProgram,"vNorm")},o.ShadowMapGenProgram.uniforms={mProj:o.gl.getUniformLocation(o.ShadowMapGenProgram,"mProj"),mView:o.gl.getUniformLocation(o.ShadowMapGenProgram,"mView"),mWorld:o.gl.getUniformLocation(o.ShadowMapGenProgram,"mWorld"),pointLightPosition:o.gl.getUniformLocation(o.ShadowMapGenProgram,"pointLightPosition"),shadowClipNearFar:o.gl.getUniformLocation(o.ShadowMapGenProgram,"shadowClipNearFar")},o.ShadowMapGenProgram.attribs={vPos:o.gl.getAttribLocation(o.ShadowMapGenProgram,"vPos")},o.shadowMapCube=o.gl.createTexture(),o.gl.bindTexture(o.gl.TEXTURE_CUBE_MAP,o.shadowMapCube),o.gl.texParameteri(o.gl.TEXTURE_CUBE_MAP,o.gl.TEXTURE_MIN_FILTER,o.gl.LINEAR),o.gl.texParameteri(o.gl.TEXTURE_CUBE_MAP,o.gl.TEXTURE_MAG_FILTER,o.gl.LINEAR),o.gl.texParameteri(o.gl.TEXTURE_CUBE_MAP,o.gl.TEXTURE_WRAP_S,o.gl.MIRRORED_REPEAT),o.gl.texParameteri(o.gl.TEXTURE_CUBE_MAP,o.gl.TEXTURE_WRAP_T,o.gl.MIRRORED_REPEAT),o.floatExtension=o.gl.getExtension("OES_texture_float"),o.floatLinearExtension=o.gl.getExtension("OES_texture_float_linear"),o.floatExtension&&o.floatLinearExtension)for(t=0;t<6;t++)o.gl.texImage2D(o.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.gl.RGBA,o.textureSize,o.textureSize,0,o.gl.RGBA,o.gl.FLOAT,null);else for(t=0;t<6;t++)o.gl.texImage2D(o.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.gl.RGBA,o.textureSize,o.textureSize,0,o.gl.RGBA,o.gl.UNSIGNED_BYTE,null);o.shadowMapFramebuffer=o.gl.createFramebuffer(),o.gl.bindFramebuffer(o.gl.FRAMEBUFFER,o.shadowMapFramebuffer),o.shadowMapRenderbuffer=o.gl.createRenderbuffer(),o.gl.bindRenderbuffer(o.gl.RENDERBUFFER,o.shadowMapRenderbuffer),o.gl.renderbufferStorage(o.gl.RENDERBUFFER,o.gl.DEPTH_COMPONENT16,o.textureSize,o.textureSize),o.gl.bindTexture(o.gl.TEXTURE_CUBE_MAP,null),o.gl.bindRenderbuffer(o.gl.RENDERBUFFER,null),o.gl.bindFramebuffer(o.gl.FRAMEBUFFER,null),o.camera=new Camera(vec3.fromValues(0,0,1.85),vec3.fromValues(-.3,-1,1.85),vec3.fromValues(0,0,1)),o.projMatrix=mat4.create(),o.viewMatrix=mat4.create(),mat4.perspective(o.projMatrix,glMatrix.toRadian(90),o.gl.canvas.clientWidth/o.gl.canvas.clientHeight,.35,85),o.shadowMapCameras=[new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(1,0,0)),vec3.fromValues(0,-1,0)),new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(-1,0,0)),vec3.fromValues(0,-1,0)),new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(0,1,0)),vec3.fromValues(0,0,1)),new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(0,-1,0)),vec3.fromValues(0,0,-1)),new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(0,0,1)),vec3.fromValues(0,-1,0)),new Camera(o.lightPosition,vec3.add(vec3.create(),o.lightPosition,vec3.fromValues(0,0,-1)),vec3.fromValues(0,-1,0))],o.shadowMapViewMatrices=[mat4.create(),mat4.create(),mat4.create(),mat4.create(),mat4.create(),mat4.create()],o.shadowMapProj=mat4.create(),o.shadowClipNearFar=vec2.fromValues(.05,15),mat4.perspective(o.shadowMapProj,glMatrix.toRadian(90),1,o.shadowClipNearFar[0],o.shadowClipNearFar[1]),e()}else e("Failed to load walls mesh");else e("Failed to load light mesh");else e("Failed to load sofa mesh");else e("Failed to load table mesh");else e("Failed to load monkey mesh")}})),o.PressedKeys={Up:!1,Right:!1,Down:!1,Left:!1,Forward:!1,Back:!1,RotLeft:!1,RotRight:!1},o.MoveForwardSpeed=3.5,o.RotateSpeed=1.5,o.textureSize=getParameterByName("texSize")||512,o.lightDisplacementInputAngle=0},LightMapDemoScene.prototype.Unload=function(){this.LightMesh=null,this.MonkeyMesh=null,this.TableMesh=null,this.SofaMesh=null,this.WallsMesh=null,this.NoShadowProgram=null,this.ShadowProgram=null,this.ShadowMapGenProgram=null,this.camera=null,this.lightPosition=null,this.Meshes=null,this.PressedKeys=null,this.MoveForwardSpeed=null,this.RotateSpeed=null,this.shadowMapCube=null,this.textureSize=null,this.shadowMapCameras=null,this.shadowMapViewMatrices=null},LightMapDemoScene.prototype.Begin=function(){console.log("Beginning demo scene");var e=this;console.log("keys",e),this.__ResizeWindowListener=this._OnResizeWindow.bind(this),this.__KeyDownWindowListener=this._OnKeyDown.bind(this),this.__KeyUpWindowListener=this._OnKeyUp.bind(this),AddEvent(window,"resize",this.__ResizeWindowListener),AddEvent(window,"keydown",this.__KeyDownWindowListener),AddEvent(window,"keyup",this.__KeyUpWindowListener);var o=performance.now(),a=0,r=function(t){a=t-o,e._Update(a),o=t,e._GenerateShadowMap(),e._Render(),e.nextFrameHandle=requestAnimationFrame(r)};e.nextFrameHandle=requestAnimationFrame(r),e._OnResizeWindow()},LightMapDemoScene.prototype.End=function(){this.__ResizeWindowListener&&RemoveEvent(window,"resize",this.__ResizeWindowListener),this.__KeyUpWindowListener&&RemoveEvent(window,"keyup",this.__KeyUpWindowListener),this.__KeyDownWindowListener&&RemoveEvent(window,"keydown",this.__KeyDownWindowListener),this.nextFrameHandle&&cancelAnimationFrame(this.nextFrameHandle)},LightMapDemoScene.prototype._Update=function(e){mat4.rotateZ(this.MonkeyMesh.world,this.MonkeyMesh.world,e/1e3*2*Math.PI*.3),this.PressedKeys.Forward&&!this.PressedKeys.Back&&this.camera.moveForward(e/1e3*this.MoveForwardSpeed),this.PressedKeys.Back&&!this.PressedKeys.Forward&&this.camera.moveForward(-e/1e3*this.MoveForwardSpeed),this.PressedKeys.Right&&!this.PressedKeys.Left&&this.camera.moveRight(e/1e3*this.MoveForwardSpeed),this.PressedKeys.Left&&!this.PressedKeys.Right&&this.camera.moveRight(-e/1e3*this.MoveForwardSpeed),this.PressedKeys.Up&&!this.PressedKeys.Down&&this.camera.moveUp(e/1e3*this.MoveForwardSpeed),this.PressedKeys.Down&&!this.PressedKeys.Up&&this.camera.moveUp(-e/1e3*this.MoveForwardSpeed),this.PressedKeys.RotRight&&!this.PressedKeys.RotLeft&&this.camera.rotateRight(-e/1e3*this.RotateSpeed),this.PressedKeys.RotLeft&&!this.PressedKeys.RotRight&&this.camera.rotateRight(e/1e3*this.RotateSpeed),this.lightDisplacementInputAngle+=e/2337;var o=2.8*Math.sin(this.lightDisplacementInputAngle);this.LightMesh.world[12]=o;for(var a=0;a<this.shadowMapCameras.length;a++)mat4.getTranslation(this.shadowMapCameras[a].position,this.LightMesh.world),this.shadowMapCameras[a].GetViewMatrix(this.shadowMapViewMatrices[a]);this.camera.GetViewMatrix(this.viewMatrix)},LightMapDemoScene.prototype._GenerateShadowMap=function(){var e=this.gl;e.useProgram(this.ShadowMapGenProgram),e.bindTexture(e.TEXTURE_CUBE_MAP,this.shadowMapCube),e.bindFramebuffer(e.FRAMEBUFFER,this.shadowMapFramebuffer),e.bindRenderbuffer(e.RENDERBUFFER,this.shadowMapRenderbuffer),e.viewport(0,0,this.textureSize,this.textureSize),e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.uniform2fv(this.ShadowMapGenProgram.uniforms.shadowClipNearFar,this.shadowClipNearFar),e.uniform3fv(this.ShadowMapGenProgram.uniforms.pointLightPosition,this.lightPosition),e.uniformMatrix4fv(this.ShadowMapGenProgram.uniforms.mProj,e.FALSE,this.shadowMapProj);for(var o=0;o<this.shadowMapCameras.length;o++){e.uniformMatrix4fv(this.ShadowMapGenProgram.uniforms.mView,e.FALSE,this.shadowMapCameras[o].GetViewMatrix(this.shadowMapViewMatrices[o])),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+o,this.shadowMapCube,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.shadowMapRenderbuffer),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var a=0;a<this.Meshes.length;a++)e.uniformMatrix4fv(this.ShadowMapGenProgram.uniforms.mWorld,e.FALSE,this.Meshes[a].world),e.bindBuffer(e.ARRAY_BUFFER,this.Meshes[a].vbo),e.vertexAttribPointer(this.ShadowMapGenProgram.attribs.vPos,3,e.FLOAT,e.FALSE,0,0),e.enableVertexAttribArray(this.ShadowMapGenProgram.attribs.vPos),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.Meshes[a].ibo),e.drawElements(e.TRIANGLES,this.Meshes[a].nPoints,e.UNSIGNED_SHORT,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)}e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null)},LightMapDemoScene.prototype._Render=function(){var e=this.gl;e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.viewport(0,0,e.canvas.clientWidth,e.canvas.clientHeight),e.clearColor(0,0,0,1),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT),e.useProgram(this.ShadowProgram),e.uniformMatrix4fv(this.ShadowProgram.uniforms.mProj,e.FALSE,this.projMatrix),e.uniformMatrix4fv(this.ShadowProgram.uniforms.mView,e.FALSE,this.viewMatrix),e.uniform3fv(this.ShadowProgram.uniforms.pointLightPosition,this.lightPosition),e.uniform2fv(this.ShadowProgram.uniforms.shadowClipNearFar,this.shadowClipNearFar),this.floatExtension&&this.floatLinearExtension?e.uniform1f(this.ShadowProgram.uniforms.bias,1e-4):e.uniform1f(this.ShadowProgram.uniforms.bias,.003),e.uniform1i(this.ShadowProgram.uniforms.lightShadowMap,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,this.shadowMapCube);for(var o=0;o<this.Meshes.length;o++)e.uniformMatrix4fv(this.ShadowProgram.uniforms.mWorld,e.FALSE,this.Meshes[o].world),e.uniform4fv(this.ShadowProgram.uniforms.meshColor,this.Meshes[o].color),e.bindBuffer(e.ARRAY_BUFFER,this.Meshes[o].vbo),e.vertexAttribPointer(this.ShadowProgram.attribs.vPos,3,e.FLOAT,e.FALSE,0,0),e.enableVertexAttribArray(this.ShadowProgram.attribs.vPos),e.bindBuffer(e.ARRAY_BUFFER,this.Meshes[o].nbo),e.vertexAttribPointer(this.ShadowProgram.attribs.vNorm,3,e.FLOAT,e.FALSE,0,0),e.enableVertexAttribArray(this.ShadowProgram.attribs.vNorm),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.Meshes[o].ibo),e.drawElements(e.TRIANGLES,this.Meshes[o].nPoints,e.UNSIGNED_SHORT,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},LightMapDemoScene.prototype._OnResizeWindow=function(){var e=this.gl,o=9*window.innerWidth/16;window.innerHeight>o?(e.canvas.width=window.innerWidth,e.canvas.height=o,e.canvas.style.left="0px",e.canvas.style.top=(window.innerHeight-o)/2+"px"):(e.canvas.width=16*window.innerHeight/9,e.canvas.height=window.innerHeight,e.canvas.style.left=(window.innerWidth-e.canvas.width)/2+"px",e.canvas.style.top="0px"),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)},LightMapDemoScene.prototype._OnKeyDown=function(e){switch(e.code){case"KeyW":this.PressedKeys.Forward=!0;break;case"KeyA":this.PressedKeys.Left=!0;break;case"KeyD":this.PressedKeys.Right=!0;break;case"KeyS":this.PressedKeys.Back=!0;break;case"ArrowUp":this.PressedKeys.Up=!0;break;case"ArrowDown":this.PressedKeys.Down=!0;break;case"ArrowRight":this.PressedKeys.RotRight=!0;break;case"ArrowLeft":this.PressedKeys.RotLeft=!0}},LightMapDemoScene.prototype._OnKeyUp=function(e){switch(e.code){case"KeyW":this.PressedKeys.Forward=!1;break;case"KeyA":this.PressedKeys.Left=!1;break;case"KeyD":this.PressedKeys.Right=!1;break;case"KeyS":this.PressedKeys.Back=!1;break;case"ArrowUp":this.PressedKeys.Up=!1;break;case"ArrowDown":this.PressedKeys.Down=!1;break;case"ArrowRight":this.PressedKeys.RotRight=!1;break;case"ArrowLeft":this.PressedKeys.RotLeft=!1}};
//# sourceMappingURL=index.1748e09f.js.map
